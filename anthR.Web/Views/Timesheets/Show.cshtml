@model IEnumerable<anthR.Web.Models.Core.MasterSite>

@{
    if (!string.IsNullOrEmpty(Request["email"]))
    {
        Layout = null;
    }
    int totalHours = 0;
    int totalIncome = 0;
    double totalQuoted = 0;
    double total = 0;

    int month = int.Parse(Request["month"].ToString());
    int daysInMonth = DateTime.DaysInMonth(DateTime.UtcNow.Year, month);
    DateTime startDate = new DateTime(DateTime.Now.Year, month, 1);
    DateTime endDate = new DateTime(DateTime.Now.Year, month, daysInMonth);

}

@if (string.IsNullOrEmpty(Request["email"]))
{
    <div class="row">
        <div class="col-sm-6">
            <form class="form-inline">
                <div class="form-group">
                    <label>Email To:</label>
                    @Html.DropDownList("StaffId", (SelectList)ViewBag.Staff, "Please Select", htmlAttributes: new { @class = "form-control" })
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" id="chkCopyMeIn" /> Copy me in
                    </label>
                </div>
                @Html.ActionLink("Send Email", "EmailTimesheet",
                new { controller = "Timesheets", month = month, email = "yes" },
                new { @class = "btn btn-sm btn-primary", target = "_blank", id = "emailLink" })
            </form>
        </div>
        <div class="col-sm-6">
            <form class="form-inline pull-right" method="get" action="/Timesheets/Show">
                <div class="form-group">
                    <label>Show Month:</label>
                    @{ Html.RenderPartial("_MonthsDropDown");}
                </div>
                <button class="btn btn-sm btn-primary" type="submit">Change Month</button>
            </form>
        </div>

     </div>
}

<ul style="margin-left: 0; padding-left: 0; list-style: none;" class="@(!string.IsNullOrEmpty(Request["email"]) ? "print": "")">

    @foreach (var item in Model)
    {

        totalHours = 0;
        totalIncome = 0;
        totalQuoted = 0;

        var hasVat = item.HasVAT;

                <li style="margin-top: 10px; border-top: solid 1px #999;">
                    <h4>@item.Name</h4>
                    <ul>
                        @if (item.Projects.Any())
                {
                    foreach (var project in item.Projects.Where(p => p.Tasks.Where(t => t.Timesheet.Where(ts => ts.DateRecorded >= startDate && ts.DateRecorded <= endDate && ts.Staff.Username.Equals(User.Identity.Name)).Any()).Any()))
                    {
                        <li style="border: none;">
                            @project.Name
                            @if (project.Quoted > 0)
                            {
                                if (project.DateCompleted.HasValue)
                                {
                                    <strong style="color: green;">Status: Completed</strong>
                                    totalQuoted += project.Quoted;
                                }
                                else
                                {
                                    <strong style="color: red;">Status: Awaiting Completion</strong>
                                }
                                <br /><span><strong>Project Quoted @@ @project.Quoted.ToString("C") @(hasVat ? "+ VAT" : "") @(project.AlreadyBilled ? "Already Billed" : "Not Billed")</strong></span>
                            }
                            <ul>
                                @if (project.Tasks.Any())
                                {
                                    foreach (var task in project.Tasks.Where(t => t.Timesheet.Where(ts => ts.DateRecorded >= startDate && ts.DateRecorded <= endDate && ts.Staff.Username.Equals(User.Identity.Name)).Any()))
                                    {
                                        <li style="border: none;">
                                            @task.Name <strong style="color: @(task.DateCompleted.HasValue ? "green": "red")">Status: @(task.DateCompleted.HasValue ? "Completed" : "Awaiting Completion")</strong>
                                            <ul>
                                                @if (task.Timesheet.Any())
                                                {
                                                    foreach (var timesheet in task.Timesheet.Where(ts => ts.DateRecorded >= startDate && ts.DateRecorded <= endDate && ts.Staff.Username.Equals(User.Identity.Name)))
                                                    {
                                                        <li>
                                                            @if (timesheet.Quoted.Equals(0) && timesheet.AnthRTask.Project.Quoted.Equals(0))
                                                            {
                                                                <span title="@timesheet.Id">@timesheet.Hours hours @@ @timesheet.HourlyRate.ToString("C")</span>
                                                                totalHours += timesheet.Hours;
                                                                totalIncome += (timesheet.Hours * timesheet.HourlyRate);
                                                            }
                                                            else if (timesheet.AnthRTask.Project.Quoted.Equals(0))
                                                            {
                                                                <span>Quoted @timesheet.Quoted.ToString("C") @(hasVat ? "+ VAT" : "") <strong>@(timesheet.AlreadyBilled ? "Already Billed" : "Not Billed")</strong></span>
                                                                totalQuoted += timesheet.Quoted;
                                                            }
                                                            else
                                                            {
                                                                <span title="@timesheet.Id">@timesheet.Hours hours</span>
                                                                totalHours += timesheet.Hours;
                                                            }
                                                            @*<a href="/Timesheets/Delete/@timesheet.Id" class="btn btn-xs"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>*@
                                                            <a href="/Timesheets/Edit/@timesheet.Id" class="btn btn-xs" title="Edit Timesheet Entry"><i class="glyphicon glyphicon-pencil"></i></a>
                                                        </li>
                                                    }
                                                }
                                            </ul>

                                        </li>
                                    }
                                }
                            </ul>
                        </li>
                    }
                }
                    </ul>







                    <br />
                    <i>
                        <strong>Total Hours: @totalHours</strong> /
                        <strong>Total Hourly Income: @totalIncome.ToString("C")</strong> /
                        <strong>Total Quoted: @totalQuoted.ToString("C")</strong> /
                        <strong>Total Income: @((totalQuoted + Convert.ToDouble(totalIncome)).ToString("C"))</strong>
                    </i>

                </li>

        total += totalQuoted + Convert.ToDouble(totalIncome);

    }

        </ul>

        <h4 style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #999;" class="text-right">
            Overall Total: @total.ToString("C")
        </h4>

        @section scripts{

            <script>
                $(function () {

                    $(document).on('click', '#emailLink', function (e) {

                        var url = $('#emailLink').attr('href');
                        var selectedEmail = $('#StaffId').val();
                        url = url.replace(/(email=)[^\&]+/, '$1' + selectedEmail);
                        url = url.replace(/(&me=)[^\&]+/, '');
                        if ($('#chkCopyMeIn').is(':checked')) {
                            url = url + '&me=1';
                        }
                        else {
                            url = url + '&me=0';
                        }
                        $('#emailLink').attr('href', url);

                        if ($('#StaffId').val() === '') {
                            e.preventDefault();
                            alert("Please Select an email.");
                            return false;
                        }

                    });
                });
            </script>
        }
